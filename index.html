<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Disc-overy - Spotify PKCE</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    max-width: 600px;
  }
  button {
    padding: 10px 15px;
    margin: 5px 0;
    cursor: pointer;
  }
  #album-info img {
    max-width: 100%;
    height: auto;
    display: block;
    margin-top: 10px;
  }
</style>
</head>
<body>
  <h1>Disc-overy</h1>

  <button id="login-btn">Iniciar sesión con Spotify</button>
  <button id="logout-btn" style="display:none;">Cerrar sesión</button>

  <section id="content" style="display:none;">
    <h2>Artistas favoritos</h2>
    <ul id="artists-list"></ul>

    <h2>Disco aleatorio para escuchar</h2>
    <button id="random-album-btn">Mostrar disco aleatorio</button>
    <div id="album-info"></div>
  </section>

<script>
const clientId = 'TU_CLIENT_ID_DE_SPOTIFY'; // reemplazá por tu clientId
const redirectUri = window.location.origin + window.location.pathname; // URL actual sin query params

const scopes = 'user-top-read user-read-private user-read-email';

const generateRandomString = length => {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let str = '';
  for (let i = 0; i < length; i++) {
    str += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return str;
};

const sha256 = async plain => {
  const encoder = new TextEncoder();
  const data = encoder.encode(plain);
  const hash = await crypto.subtle.digest('SHA-256', data);
  return new Uint8Array(hash);
};

const base64urlencode = arrayBuffer => {
  let str = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)));
  return str.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
};

const pkceChallengeFromVerifier = async v => {
  const hashed = await sha256(v);
  return base64urlencode(hashed);
};

const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const artistsList = document.getElementById('artists-list');
const content = document.getElementById('content');
const randomAlbumBtn = document.getElementById('random-album-btn');
const albumInfo = document.getElementById('album-info');

let accessToken = null;

const setSessionStorage = (key, value) => sessionStorage.setItem(key, value);
const getSessionStorage = key => sessionStorage.getItem(key);
const removeSessionStorage = key => sessionStorage.removeItem(key);

async function redirectToSpotifyAuth() {
  const codeVerifier = generateRandomString(128);
  const codeChallenge = await pkceChallengeFromVerifier(codeVerifier);

  setSessionStorage('code_verifier', codeVerifier);

  const url = new URL('https://accounts.spotify.com/authorize');
  url.searchParams.append('client_id', clientId);
  url.searchParams.append('response_type', 'code');
  url.searchParams.append('redirect_uri', redirectUri);
  url.searchParams.append('scope', scopes);
  url.searchParams.append('code_challenge_method', 'S256');
  url.searchParams.append('code_challenge', codeChallenge);

  window.location = url.toString();
}

async function fetchAccessToken(code) {
  const codeVerifier = getSessionStorage('code_verifier');

  const body = new URLSearchParams({
    client_id: clientId,
    grant_type: 'authorization_code',
    code: code,
    redirect_uri: redirectUri,
    code_verifier: codeVerifier,
  });

  const response = await fetch('https://accounts.spotify.com/api/token', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: body.toString(),
  });

  if (!response.ok) {
    alert('Error obteniendo el token');
    console.error(await response.text());
    return null;
  }

  const data = await response.json();
  return data;
}

async function getUserTopArtists(token) {
  const res = await fetch('https://api.spotify.com/v1/me/top/artists?limit=10', {
    headers: { Authorization: 'Bearer ' + token },
  });
  if (!res.ok) {
    alert('Error cargando artistas');
    return [];
  }
  const data = await res.json();
  return data.items;
}

async function getRandomAlbum(token) {
  const artists = await getUserTopArtists(token);
  if (artists.length === 0) return null;

  const artist = artists[Math.floor(Math.random() * artists.length)];

  const res = await fetch(`https://api.spotify.com/v1/artists/${artist.id}/albums?include_groups=album&limit=50`, {
    headers: { Authorization: 'Bearer ' + token },
  });
  if (!res.ok) return null;

  const albums = (await res.json()).items;
  if (albums.length === 0) return null;

  const album = albums[Math.floor(Math.random() * albums.length)];
  return album;
}

function showArtists(artists) {
  artistsList.innerHTML = '';
  artists.forEach(a => {
    const li = document.createElement('li');
    li.textContent = a.name;
    artistsList.appendChild(li);
  });
}

function showAlbum(album) {
  if (!album) {
    albumInfo.innerHTML = '<p>No se encontró álbum.</p>';
    return;
  }
  albumInfo.innerHTML = `
    <h3>${album.name}</h3>
    <p>Por ${album.artists.map(a => a.name).join(', ')}</p>
    <img src="${album.images[0]?.url || ''}" alt="Portada álbum" />
    <a href="${album.external_urls.spotify}" target="_blank" rel="noopener noreferrer">Escuchar en Spotify</a>
  `;
}

async function handleRedirect() {
  const params = new URLSearchParams(window.location.search);
  const code = params.get('code');

  if (!code) return;

  const tokenData = await fetchAccessToken(code);
  if (!tokenData) return;

  accessToken = tokenData.access_token;
  sessionStorage.setItem('access_token', accessToken);

  // Limpio query params
  window.history.replaceState({}, document.title, redirectUri);

  showContent();
}

async function showContent() {
  accessToken = sessionStorage.getItem('access_token');
  if (!accessToken) {
    loginBtn.style.display = 'block';
    logoutBtn.style.display = 'none';
    content.style.display = 'none';
    return;
  }

  loginBtn.style.display = 'none';
  logoutBtn.style.display = 'block';
  content.style.display = 'block';

  const artists = await getUserTopArtists(accessToken);
  showArtists(artists);
}

loginBtn.addEventListener('click', () => {
  redirectToSpotifyAuth();
});

logoutBtn.addEventListener('click', () => {
  sessionStorage.clear();
  location.reload();
});

randomAlbumBtn.addEventListener('click', async () => {
  const album = await getRandomAlbum(accessToken);
  showAlbum(album);
});

window.onload = () => {
  handleRedirect();
  showContent();
};
</script>
</body>
</html>
